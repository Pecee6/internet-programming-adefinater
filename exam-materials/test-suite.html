<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Who Episodes Explorer - Test Suite</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2a5298;
            margin-bottom: 20px;
        }

        .test-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .pass {
            background: #d4edda;
            color: #155724;
        }

        .fail {
            background: #f8d7da;
            color: #721c24;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        #results {
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        button {
            background: #2a5298;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #1e3c72;
        }

        input {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Doctor Who Episodes Explorer - Test Suite</h1>
        
        <div class="test-group">
            <label for="submission-url">Submission URL:</label>
            <input type="text" id="submission-url" placeholder="Enter student submission URL">
            <button onclick="runTests()">Run Tests</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Test suite configuration
        const config = {
            requiredColumns: ['rank', 'title', 'series', 'era', 'broadcast_date', 'director', 'writer', 'doctor', 'companion', 'cast'],
            minRows: 100,
            timeoutMs: 5000
        };

        // Test result storage
        let testResults = {
            basic: {},
            edgeCases: {},
            advanced: {},
            score: 0
        };

        async function runTests() {
            const url = document.getElementById('submission-url').value;
            if (!url) {
                alert('Please enter a submission URL');
                return;
            }

            clearResults();
            await loadSubmission(url);
            
            // Run all test categories
            await runBasicTests();
            await runEdgeCaseTests();
            await runAdvancedTests();
            
            calculateScore();
            displayResults();
        }

        async function loadSubmission(url) {
            try {
                // Create iframe and load submission
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = url;
                document.body.appendChild(iframe);

                // Wait for load or timeout
                await Promise.race([
                    new Promise(resolve => iframe.onload = resolve),
                    new Promise((_, reject) => setTimeout(() => reject('Load timeout'), config.timeoutMs))
                ]);

                logResult('basic', 'pageLoad', true, 'Page loaded successfully');
            } catch (error) {
                logResult('basic', 'pageLoad', false, `Failed to load page: ${error}`);
            }
        }

        async function runBasicTests() {
            // Test 1: Table structure
            testTableStructure();

            // Test 2: Sorting functionality
            testSorting();

            // Test 3: Filter functionality
            testFiltering();

            // Test 4: Loading state
            testLoadingState();
        }

        function testTableStructure() {
            try {
                const table = document.querySelector('table');
                if (!table) {
                    logResult('basic', 'tableExists', false, 'No table element found');
                    return;
                }

                // Check headers
                const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim().toLowerCase());
                const missingColumns = config.requiredColumns.filter(col => !headers.includes(col));
                
                if (missingColumns.length === 0) {
                    logResult('basic', 'requiredColumns', true, 'All required columns present');
                } else {
                    logResult('basic', 'requiredColumns', false, `Missing columns: ${missingColumns.join(', ')}`);
                }

                // Check row count
                const rows = table.querySelectorAll('tbody tr');
                if (rows.length >= config.minRows) {
                    logResult('basic', 'rowCount', true, `Found ${rows.length} rows`);
                } else {
                    logResult('basic', 'rowCount', false, `Only ${rows.length} rows found, expected ${config.minRows}`);
                }
            } catch (error) {
                logResult('basic', 'tableStructure', false, `Error checking table: ${error}`);
            }
        }

        function testSorting() {
            try {
                // Check for sort indicators
                const headers = document.querySelectorAll('th');
                let sortableCount = 0;

                headers.forEach(header => {
                    // Look for click handlers or sort indicators
                    const hasClick = header.onclick || header.dataset.sort;
                    const hasIndicator = header.querySelector('.sort-indicator') || 
                                       header.classList.contains('sortable') ||
                                       header.dataset.sortDirection;
                    
                    if (hasClick || hasIndicator) sortableCount++;
                });

                if (sortableCount > 0) {
                    logResult('basic', 'sortingImplemented', true, `Found ${sortableCount} sortable columns`);
                } else {
                    logResult('basic', 'sortingImplemented', false, 'No sortable columns found');
                }
            } catch (error) {
                logResult('basic', 'sorting', false, `Error checking sorting: ${error}`);
            }
        }

        function testFiltering() {
            try {
                // Check for filter input
                const filterInput = document.querySelector('input[type="text"]');
                if (!filterInput) {
                    logResult('basic', 'filterExists', false, 'No text filter input found');
                    return;
                }

                // Test filter functionality
                const originalRows = document.querySelectorAll('tbody tr').length;
                filterInput.value = 'test';
                filterInput.dispatchEvent(new Event('input'));
                
                // Wait for potential debounce
                setTimeout(() => {
                    const filteredRows = document.querySelectorAll('tbody tr').length;
                    if (filteredRows !== originalRows) {
                        logResult('basic', 'filterWorks', true, 'Filter updates table content');
                    } else {
                        logResult('basic', 'filterWorks', false, 'Filter does not update table content');
                    }
                }, 500);
            } catch (error) {
                logResult('basic', 'filtering', false, `Error checking filtering: ${error}`);
            }
        }

        function testLoadingState() {
            try {
                const loadingElement = document.getElementById('loading') || 
                                     document.querySelector('.loading') ||
                                     document.querySelector('[aria-busy="true"]');
                
                if (loadingElement) {
                    logResult('basic', 'loadingState', true, 'Loading state implementation found');
                } else {
                    logResult('basic', 'loadingState', false, 'No loading state implementation found');
                }
            } catch (error) {
                logResult('basic', 'loadingState', false, `Error checking loading state: ${error}`);
            }
        }

        async function runEdgeCaseTests() {
            // Test 1: Null companion handling
            testNullCompanions();

            // Test 2: Empty cast arrays
            testEmptyCast();

            // Test 3: Multiple writers
            testMultipleWriters();

            // Test 4: Special characters
            testSpecialCharacters();
        }

        function testNullCompanions() {
            try {
                const companionCells = document.querySelectorAll('td[data-field="companion"]');
                let nullHandled = false;

                companionCells.forEach(cell => {
                    const text = cell.textContent.trim().toLowerCase();
                    if (text === 'none' || text === '—' || text === '-' || text === 'no companion') {
                        nullHandled = true;
                    }
                });

                logResult('edgeCases', 'nullCompanions', nullHandled, 
                    nullHandled ? 'Null companions handled appropriately' : 'No proper null companion handling found');
            } catch (error) {
                logResult('edgeCases', 'nullCompanions', false, `Error checking null companions: ${error}`);
            }
        }

        function testEmptyCast() {
            try {
                const castCells = document.querySelectorAll('td[data-field="cast"]');
                let emptyHandled = false;

                castCells.forEach(cell => {
                    const text = cell.textContent.trim();
                    if (text === '0' || text === 'No cast' || text === '—') {
                        emptyHandled = true;
                    }
                });

                logResult('edgeCases', 'emptyCast', emptyHandled,
                    emptyHandled ? 'Empty cast arrays handled appropriately' : 'No proper empty cast handling found');
            } catch (error) {
                logResult('edgeCases', 'emptyCast', false, `Error checking empty cast: ${error}`);
            }
        }

        function testMultipleWriters() {
            try {
                const writerCells = document.querySelectorAll('td[data-field="writer"]');
                let multipleWritersHandled = false;

                writerCells.forEach(cell => {
                    const text = cell.textContent.trim();
                    if (text.includes('&') || text.includes(',')) {
                        multipleWritersHandled = true;
                    }
                });

                logResult('edgeCases', 'multipleWriters', multipleWritersHandled,
                    multipleWritersHandled ? 'Multiple writers displayed properly' : 'No multiple writer handling found');
            } catch (error) {
                logResult('edgeCases', 'multipleWriters', false, `Error checking multiple writers: ${error}`);
            }
        }

        function testSpecialCharacters() {
            try {
                const titleCells = document.querySelectorAll('td[data-field="title"]');
                let specialCharsHandled = false;

                titleCells.forEach(cell => {
                    const text = cell.textContent;
                    if (text.includes("'") || text.includes('"') || text.includes('/')) {
                        specialCharsHandled = true;
                    }
                });

                logResult('edgeCases', 'specialChars', specialCharsHandled,
                    specialCharsHandled ? 'Special characters rendered correctly' : 'No special character handling found');
            } catch (error) {
                logResult('edgeCases', 'specialChars', false, `Error checking special characters: ${error}`);
            }
        }

        async function runAdvancedTests() {
            // Test 1: Performance optimization
            testPerformance();

            // Test 2: Keyboard navigation
            testKeyboardNavigation();

            // Test 3: Smart sorting
            testSmartSort();

            // Test 4: Data validation
            testDataValidation();
        }

        function testPerformance() {
            try {
                // Check for common optimization techniques
                const virtualization = document.querySelector('[data-virtualized]') ||
                                     document.querySelector('.virtual-scroll');
                                     
                const pagination = document.querySelector('.pagination') ||
                                 document.querySelector('[data-page]');
                                 
                const lazyLoading = document.querySelector('[data-lazy]') ||
                                  document.querySelector('.lazy-load');

                const hasOptimization = virtualization || pagination || lazyLoading;
                
                logResult('advanced', 'performance', hasOptimization,
                    hasOptimization ? 'Performance optimization detected' : 'No performance optimization found');
            } catch (error) {
                logResult('advanced', 'performance', false, `Error checking performance: ${error}`);
            }
        }

        function testKeyboardNavigation() {
            try {
                // Test keyboard event handlers
                let keyboardNavigation = false;
                
                document.querySelectorAll('th, td').forEach(cell => {
                    if (cell.tabIndex === 0 || cell.getAttribute('role') === 'button') {
                        keyboardNavigation = true;
                    }
                });

                logResult('advanced', 'keyboardNav', keyboardNavigation,
                    keyboardNavigation ? 'Keyboard navigation implemented' : 'No keyboard navigation found');
            } catch (error) {
                logResult('advanced', 'keyboardNav', false, `Error checking keyboard navigation: ${error}`);
            }
        }

        function testSmartSort() {
            try {
                // Test if sort changes when filter is active
                const filterInput = document.querySelector('input[type="text"]');
                if (!filterInput) return;

                const originalOrder = getTableOrder();
                filterInput.value = 'test';
                filterInput.dispatchEvent(new Event('input'));

                setTimeout(() => {
                    const newOrder = getTableOrder();
                    const hasSmartSort = JSON.stringify(originalOrder) !== JSON.stringify(newOrder);

                    logResult('advanced', 'smartSort', hasSmartSort,
                        hasSmartSort ? 'Smart sort detected' : 'No smart sort implementation found');
                }, 500);
            } catch (error) {
                logResult('advanced', 'smartSort', false, `Error checking smart sort: ${error}`);
            }
        }

        function testDataValidation() {
            try {
                // Check console for validation warnings
                const originalConsoleWarn = console.warn;
                let validationWarnings = 0;

                console.warn = function(...args) {
                    if (args[0].includes('validation') || args[0].includes('warning')) {
                        validationWarnings++;
                    }
                    originalConsoleWarn.apply(console, args);
                };

                // Restore original after brief timeout
                setTimeout(() => {
                    console.warn = originalConsoleWarn;
                    logResult('advanced', 'dataValidation', validationWarnings > 0,
                        validationWarnings > 0 ? `Found ${validationWarnings} validation warnings` : 'No data validation found');
                }, 1000);
            } catch (error) {
                logResult('advanced', 'dataValidation', false, `Error checking data validation: ${error}`);
            }
        }

        function getTableOrder() {
            const rows = document.querySelectorAll('tbody tr');
            return Array.from(rows).map(row => row.textContent.trim());
        }

        function logResult(category, test, passed, message) {
            if (!testResults[category]) testResults[category] = {};
            testResults[category][test] = { passed, message };
        }

        function calculateScore() {
            let score = 0;
            
            // Basic functionality (60 points)
            const basicTests = Object.values(testResults.basic);
            score += (basicTests.filter(t => t.passed).length / basicTests.length) * 60;

            // Edge cases (25 points)
            const edgeCaseTests = Object.values(testResults.edgeCases);
            score += (edgeCaseTests.filter(t => t.passed).length / edgeCaseTests.length) * 25;

            // Advanced features (15 points)
            const advancedTests = Object.values(testResults.advanced);
            score += (advancedTests.filter(t => t.passed).length / advancedTests.length) * 15;

            testResults.score = Math.round(score);
        }

        function clearResults() {
            testResults = {
                basic: {},
                edgeCases: {},
                advanced: {},
                score: 0
            };
            document.getElementById('results').innerHTML = '';
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            let html = '<h2>Test Results</h2>';

            // Display score
            html += `<div class="test-group">
                        <h3>Overall Score: ${testResults.score}/100</h3>
                    </div>`;

            // Display results by category
            ['basic', 'edgeCases', 'advanced'].forEach(category => {
                html += `<div class="test-group">
                            <h3>${category.charAt(0).toUpperCase() + category.slice(1)} Tests</h3>`;
                
                Object.entries(testResults[category]).forEach(([test, result]) => {
                    html += `<div class="test-result ${result.passed ? 'pass' : 'fail'}">
                                <strong>${test}:</strong> ${result.message}
                            </div>`;
                });

                html += '</div>';
            });

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>